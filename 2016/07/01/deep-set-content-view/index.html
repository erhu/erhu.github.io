<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>深入理解View(一)：从setContentView谈起 | 四十岁退休</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.1.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/2.2.3/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">深入理解View(一)：从setContentView谈起</h1><a id="logo" href="/.">四十岁退休</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">深入理解View(一)：从setContentView谈起</h1><div class="post-meta">Jul 1, 2016<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>我们都知道 <strong>MVC</strong>，在Android中，这个 <strong>V</strong> 即指View，那我们今天就来探探View的究竟。</p>
<p>在onCreate方法中，可以调用this.setContentView(layout_id)，来设置这个Activity的视图，今天就从setContentView(…)说起吧。</p>
<p>先编写一个简单的Activity:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public <span class="class"><span class="keyword">class</span> <span class="title">ViewDemoActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="keyword">protected</span> void onCreate(<span class="type">Bundle</span> savedInstanceState) &#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        <span class="keyword">super</span>.setContentView(<span class="type">R</span>.layout.view_demo);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查看父类Activity的setContentView方法:<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</div><div class="line">    getWindow().setContentView(layoutResID);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个getWindow()指向哪里？我们在onCreate中打个log瞧瞧:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">D/ViewDemoActivity(<span class="number">3969</span>): com<span class="selector-class">.android</span><span class="selector-class">.internal</span><span class="selector-class">.policy</span><span class="selector-class">.impl</span><span class="selector-class">.PhoneWindow</span></div></pre></td></tr></table></figure>
<p>原来是PhoneWindow，来看看它的setContentView方法：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(<span class="keyword">int</span> layoutResID)</span> </span>&#123;</div><div class="line">    <span class="comment">// 1</span></div><div class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">        installDecor();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mContentParent.removeAllViews();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 2</span></div><div class="line">    mLayoutInflater.inflate(layoutResID, mContentParent);</div><div class="line"></div><div class="line">    <span class="comment">// 3</span></div><div class="line">    <span class="keyword">final</span> Callback cb = getCallback();</div><div class="line">    <span class="keyword">if</span> (cb != <span class="keyword">null</span> &amp;&amp; !isDestroyed()) &#123;</div><div class="line">        cb.onContentChanged();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们分三步来介绍这个方法：</p>
<h2 id="第一步：判断父容器是否为空"><a href="#第一步：判断父容器是否为空" class="headerlink" title="第一步：判断父容器是否为空"></a>第一步：判断父容器是否为空</h2><p>为空：生成Decor； (Decor是什么？参看<a href="http://www.jianshu.com/p/16d156bdfd04" target="_blank" rel="external">这篇文章</a>)<br>不为空：删除 contentParent 所有的子控件。</p>
<h2 id="第二步：解析layoutResID所代表的xml文件"><a href="#第二步：解析layoutResID所代表的xml文件" class="headerlink" title="第二步：解析layoutResID所代表的xml文件"></a>第二步：解析layoutResID所代表的xml文件</h2><p>直接看LayoutInflater.inflate(…)方法：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 为节省篇幅，删除一些调试代码 </span></div><div class="line"><span class="keyword">public</span> <span class="function">View <span class="title">inflate</span><span class="params">(<span class="keyword">int</span> resource, ViewGroup root)</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">return</span> <span class="title">inflate</span><span class="params">(resource, root, root != <span class="keyword">null</span>)</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function">View <span class="title">inflate</span><span class="params">(<span class="keyword">int</span> resource, ViewGroup root, <span class="keyword">boolean</span> attachToRoot)</span> </span>&#123;</div><div class="line">    XmlResourceParser parser = getContext().getResources().getLayout(resource);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="function"><span class="keyword">return</span> <span class="title">inflate</span><span class="params">(parser, root, attachToRoot)</span></span>;</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        parser.close();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function">View <span class="title">inflate</span><span class="params">(XmlPullParser parser, ViewGroup root, <span class="keyword">boolean</span> attachToRoot)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (mConstructorArgs) &#123;</div><div class="line">        <span class="keyword">final</span> AttributeSet attrs = Xml.asAttributeSet(parser);</div><div class="line">        Context lastContext = (Context)mConstructorArgs[<span class="number">0</span>];</div><div class="line">        mConstructorArgs[<span class="number">0</span>] = mContext;</div><div class="line">        View result = root;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// Look for the root node.</span></div><div class="line">            <span class="keyword">int</span> type;</div><div class="line">            <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp;</div><div class="line">                    type != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line">                <span class="comment">// Empty</span></div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (type != XmlPullParser.START_TAG) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(parser.getPositionDescription()   </div><div class="line">                          + <span class="string">": No start tag found!"</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">final</span> String name = parser.getName();</div><div class="line">            </div><div class="line">            <span class="comment">// 根标签为merge时，root不能为空</span></div><div class="line">            <span class="keyword">if</span> (TAG_MERGE.equals(name)) &#123;</div><div class="line">                <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> InflateException(<span class="string">"&lt;merge /&gt; can be used only with a valid "</span></div><div class="line">                            + <span class="string">"ViewGroup root and attachToRoot=true"</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                rInflate(parser, root, attrs, <span class="keyword">false</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Temp is the root view that was found in the xml</span></div><div class="line">                View temp;</div><div class="line">                <span class="keyword">if</span> (TAG_1995.equals(name)) &#123;</div><div class="line">                    temp = <span class="keyword">new</span> BlinkLayout(mContext, attrs);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    temp = createViewFromTag(root, name, attrs);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                ViewGroup.LayoutParams params = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (root != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// Create layout params that match root, if supplied</span></div><div class="line">                    params = root.generateLayoutParams(attrs);</div><div class="line">                    <span class="keyword">if</span> (!attachToRoot) &#123;</div><div class="line">                        <span class="comment">// Set the layout params for temp if we are not attaching. </span></div><div class="line">                        <span class="comment">// (If we are, we use addView, below)</span></div><div class="line">                        temp.setLayoutParams(params);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 解析temp的所有子View</span></div><div class="line">                rInflate(parser, temp, attrs, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">                <span class="comment">// 将temp添加到root中</span></div><div class="line">                <span class="keyword">if</span> (root != <span class="keyword">null</span> &amp;&amp; attachToRoot) &#123;</div><div class="line">                    root.addView(temp, params);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="comment">// 如果未指定root或者不附加到root，则返回xml所代表的view;</span></div><div class="line">                <span class="keyword">if</span> (root == <span class="keyword">null</span> || !attachToRoot) &#123;</div><div class="line">                    result = temp;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</div><div class="line">            InflateException ex = <span class="keyword">new</span> InflateException(e.getMessage());</div><div class="line">            ex.initCause(e);</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            InflateException ex = <span class="keyword">new</span> InflateException(parser.getPositionDescription()</div><div class="line">                + <span class="string">": "</span> + e.getMessage());</div><div class="line">            ex.initCause(e);</div><div class="line">            <span class="keyword">throw</span> ex;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// Don't retain static reference on context.</span></div><div class="line">            mConstructorArgs[<span class="number">0</span>] = lastContext;</div><div class="line">            mConstructorArgs[<span class="number">1</span>] = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>(这几个inflate方法内部的逻辑，请参看注释)<br>我们注意到，inflate(…)最终会调用rInflate(…)，继续挖：<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="literal">void</span> rInflate(XmlPullParser parser, View <span class="keyword">parent</span>, final AttributeSet attrs,</div><div class="line">        <span class="built_in">boolean</span> finishInflate) throws XmlPullParserException, IOException &#123;</div><div class="line">    final int depth = parser.getDepth();</div><div class="line">    int <span class="keyword">type</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (((<span class="keyword">type</span> = parser.next()) != XmlPullParser.END_TAG ||</div><div class="line">            parser.getDepth() &gt; depth) &amp;&amp; <span class="keyword">type</span> != XmlPullParser.END_DOCUMENT) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">type</span> != XmlPullParser.START_TAG) &#123;</div><div class="line">            continue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        final <span class="built_in">String</span> name = parser.getName();</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (TAG_REQUEST_FOCUS.<span class="keyword">equals</span>(name)) &#123;</div><div class="line">            parseRequestFocus(parser, <span class="keyword">parent</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_INCLUDE.<span class="keyword">equals</span>(name)) &#123;</div><div class="line">            <span class="keyword">if</span> (parser.getDepth() == <span class="number">0</span>) &#123;</div><div class="line">                throw <span class="literal">new</span> InflateException(<span class="string">"&lt;include /&gt; cannot be the root element"</span>);</div><div class="line">            &#125;</div><div class="line">            parseInclude(parser, <span class="keyword">parent</span>, attrs);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_MERGE.<span class="keyword">equals</span>(name)) &#123;</div><div class="line">            throw <span class="literal">new</span> InflateException(<span class="string">"&lt;merge /&gt; must be the root element"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TAG_1995.<span class="keyword">equals</span>(name)) &#123;</div><div class="line">            final View view = <span class="literal">new</span> BlinkLayout(mContext, attrs);</div><div class="line">            final ViewGroup viewGroup = (ViewGroup) <span class="keyword">parent</span>;</div><div class="line">            final ViewGroup.LayoutParams <span class="keyword">params</span> = viewGroup.generateLayoutParams(attrs);</div><div class="line">            rInflate(parser, view, attrs, <span class="literal">true</span>);</div><div class="line">            viewGroup.addView(view, <span class="keyword">params</span>);                </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            final View view = createViewFromTag(<span class="keyword">parent</span>, name, attrs);</div><div class="line">            final ViewGroup viewGroup = (ViewGroup) <span class="keyword">parent</span>;</div><div class="line">            final ViewGroup.LayoutParams <span class="keyword">params</span> = viewGroup.generateLayoutParams(attrs);</div><div class="line">            rInflate(parser, view, attrs, <span class="literal">true</span>);</div><div class="line">            viewGroup.addView(view, <span class="keyword">params</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (finishInflate) <span class="keyword">parent</span>.onFinishInflate();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>rInflate(…)先特殊处理了几个xml标签<code>merge</code>， <code>include</code>， <code>blink</code>，<code>requestFocus</code>，<br>然后在else分支，会 <strong>递归</strong> 调用rInflate(…)，将xml的子控件添加到parent中，生成完整的 <strong>contentView</strong>。<br>看了这里，同学们就会明白，为什么<strong>不建议在布局文件中做过多地View嵌套</strong>了吧，层层递归啊:(</p>
<h2 id="第三步：通知Callback，ContentView发生改变"><a href="#第三步：通知Callback，ContentView发生改变" class="headerlink" title="第三步：通知Callback，ContentView发生改变"></a>第三步：通知Callback，ContentView发生改变</h2><p>这个<code>getCallback()</code>是什么？打个Log看看：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@<span class="keyword">Override</span></div><div class="line">protected void onCreate(Bundle savedInstanceState) &#123;</div><div class="line">    <span class="selector-tag">super</span><span class="selector-class">.onCreate</span>(<span class="selector-tag">savedInstanceState</span>);</div><div class="line">    <span class="selector-tag">super</span><span class="selector-class">.setContentView</span>(<span class="selector-tag">R</span><span class="selector-class">.layout</span><span class="selector-class">.view_demo</span>);</div><div class="line">    <span class="selector-tag">Log</span><span class="selector-class">.d</span>("<span class="selector-tag">ViewDemo</span>", <span class="selector-tag">getWindow</span>()<span class="selector-class">.getCallback</span>()<span class="selector-class">.toString</span>());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>输出结果为：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">D/ViewDemoActivity( <span class="number">7228</span>): cn<span class="selector-class">.erhu</span><span class="selector-class">.android</span><span class="selector-class">.view</span><span class="selector-class">.ViewDemoActivity</span>@<span class="number">6562</span>f2c0</div></pre></td></tr></table></figure></p>
<p>这不就是ViewDemoActivity吗？<br>在Activity.java中，我们在attach()方法中发现了蛛丝马迹：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">final</span> <span class="function"><span class="keyword">void</span> <span class="title">attach</span><span class="params">(...)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    mWindow = PolicyManager.makeNewWindow(<span class="keyword">this</span>);</div><div class="line">    mWindow.setCallback(<span class="keyword">this</span>);</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onContentChanged</span><span class="params">()</span> </span>&#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们发现原来PhoneWindow的callback原来就是Activity，并且Activity的onContentChanged()方法是空的，所以我们可以在自己的Activity中重写这个方法，来监听ContentView发生改变的事件。</p>
<p>OK，setContentView()大体就是这么回事，下面再补充几个知识点。</p>
<hr>
<h1 id="补充知识点"><a href="#补充知识点" class="headerlink" title="补充知识点"></a>补充知识点</h1><h3 id="1、PhoneWindows的mLayoutInflater是哪里来的？"><a href="#1、PhoneWindows的mLayoutInflater是哪里来的？" class="headerlink" title="1、PhoneWindows的mLayoutInflater是哪里来的？"></a>1、PhoneWindows的mLayoutInflater是哪里来的？</h3><p>PhoneWindow.java<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">public PhoneWindow(<span class="built_in">Context</span> <span class="built_in">context</span>) &#123;</div><div class="line">    super(<span class="built_in">context</span>)<span class="comment">;</span></div><div class="line">    mLayoutInflater = LayoutInflater.from(<span class="built_in">context</span>)<span class="comment">;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>LayoutInflater.java<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">LayoutInflater <span class="title">from</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    LayoutInflater LayoutInflater =</div><div class="line">            (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);</div><div class="line">    <span class="keyword">if</span> (LayoutInflater == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"LayoutInflater not found."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> LayoutInflater;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ContextImpl.java<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="keyword">public</span> <span class="function">Object <span class="title">getSystemService</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    ServiceFetcher fetcher = SYSTEM_SERVICE_MAP.get(name);</div><div class="line">    <span class="keyword">return</span> fetcher == <span class="keyword">null</span> ? <span class="keyword">null</span> : fetcher.getService(<span class="keyword">this</span>);</div><div class="line">&#125;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="function"><span class="keyword">void</span> <span class="title">registerService</span><span class="params">(String serviceName, ServiceFetcher fetcher)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!(fetcher <span class="keyword">instanceof</span> StaticServiceFetcher)) &#123;</div><div class="line">        fetcher.mContextCacheIndex = sNextPerContextServiceCacheIndex++;</div><div class="line">    &#125;</div><div class="line">    SYSTEM_SERVICE_MAP.put(serviceName, fetcher);</div><div class="line">&#125;</div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    ...</div><div class="line">    registerService(LAYOUT_INFLATER_SERVICE, <span class="keyword">new</span> ServiceFetcher() &#123;</div><div class="line">            <span class="keyword">public</span> <span class="function">Object <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">                <span class="keyword">return</span> PolicyManager.makeNewLayoutInflater(ctx.getOuterContext());</div><div class="line">            &#125;&#125;);</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>原来，<strong>mLayoutInflater是ContextImpl.java在加载的时候，调用PolicyManager.makeNewLayoutInflater生成的</strong>：</p>
<p>PoliceManager.java<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String POLICY_IMPL_CLASS_NAME = <span class="string">"com.android.internal.policy.impl.Policy"</span>;</div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> IPolicy sPolicy;</div><div class="line"></div><div class="line"><span class="keyword">static</span> &#123;</div><div class="line">    <span class="comment">// Pull in the actual implementation of the policy at run-time</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Class policyClass = Class.forName(POLICY_IMPL_CLASS_NAME);</div><div class="line">        sPolicy = (IPolicy)policyClass.newInstance();</div><div class="line">        ...</div><div class="line">&#125;</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function">LayoutInflater <span class="title">makeNewLayoutInflater</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">return</span> sPolicy.<span class="title">makeNewLayoutInflater</span><span class="params">(context)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最终定位到Policy.java<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> LayoutInflater <span class="title">makeNewLayoutInflater</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PhoneLayoutInflater(context);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>mLayoutInflater是一个PhoneLayoutInflater，这便是mInflaterLayout的由来。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://erhu.party/2016/07/01/deep-set-content-view/" data-id="citma9z8n0003vkqargeom92o" class="article-share-link">分享到</a><div class="tags"><a href="/tags/android/">android</a></div><div class="post-nav"><a href="/2016/07/01/deep-set-content-view-2/" class="pre">深入理解View(二)：Activity的页面结构</a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/camera/" style="font-size: 15px;">camera</a> <a href="/tags/android/" style="font-size: 15px;">android</a> <a href="/tags/scinece/" style="font-size: 15px;">scinece</a> <a href="/tags/emacs/" style="font-size: 15px;">emacs</a> <a href="/tags/todo/" style="font-size: 15px;">todo</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/09/28/camera-3/">我的第三台相机</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/26/huan-qiu-ke-xue/">环球科学</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/22/my-first-emacs-function/">我的第一个Emacs函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/01/deep-set-content-view-2/">深入理解View(二)：Activity的页面结构</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/07/01/deep-set-content-view/">深入理解View(一)：从setContentView谈起</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">四十岁退休.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>